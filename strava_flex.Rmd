---
title: "Strava-flex"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    source_code: https://github.com/rafaelschlatter/strava-flex
    social: menu
#runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(rStrava)
library(jsonlite)
library(ggplot2)
library(plotly)
library(highcharter)
library(shiny)

strava_keys = fromJSON('keys.json')$strava
strava_goals = fromJSON('keys.json')$goals
stoken <- httr::config(token = strava_oauth(strava_keys$app_name,
                                            strava_keys$client_id,
                                            strava_keys$client_secret))

activities <- get_activity_list(stoken)
athlete <- get_athlete(stoken)
df <- compile_activities(activities)
df$row <- seq.int(nrow(df))
df$calendar_date <- as.Date(df$start_date)
```

Sidebar {.sidebar}
=======================================================================
### Athlete Information
```{r}
athlete$firstname
athlete$lastname
athlete$city
athlete$country
```


Year-to-date statistics {data-icon="fa-chart-bar"}
=======================================================================
Column
-----------------------------------------------------------------------
### Yearly goal
Your current yearly km goal is set to `r strava_goals$yearly_km`km.
```{r}
yearly_activites = subset(df, calendar_date > as.Date("2018-12-31"))
current_distance = round(sum(yearly_activites$distance), digits = 1)

first = strava_goals$yearly_km / 3
second = first * 2

gauge(current_distance, min = 0, max = strava_goals$yearly_km, symbol = 'km', gaugeSectors(
  success = c(second+1, strava_goals$yearly_km), warning = c(first+1, second), danger = c(0, first)
))
```

Column
-----------------------------------------------------------------------
### Weekly activity minutes
Your current weekly activity goal is set to `r strava_goals$weekly_min` min. 
```{r}
current_date <- Sys.Date()
current_day <- weekdays(current_date)

if (current_day == "Monday") {
  weekstart <- current_date
} else if (current_day == "Tuesday") {
  weekstart <- current_date - 1
} else if (current_day == "Wednesday") {
  weekstart <- current_date - 2
} else if (current_day == "Thursday") {
  weekstart <- current_date - 3
} else if (current_day == "Friday") {
  weekstart <- current_date - 4
} else if (current_day == "Saturday") {
  weekstart <- current_date - 5
} else {
  weekstart <- current_date - 6
}

weekly_activites = subset(df, calendar_date > weekstart)
weekly_min = round(sum(weekly_activites$elapsed_time) / 60)

first = strava_goals$weekly_min / 3
second = first * 2

gauge(weekly_min, min = 0, max = strava_goals$weekly_min, symbol = 'min', gaugeSectors(
  success = c(second+1, strava_goals$weekly_min), warning = c(first+1, second), danger = c(0, first)
))
```

Column
-----------------------------------------------------------------------
### Placeholder
```{r}
yearly_activites = subset(df, calendar_date > as.Date("2018-12-31"))
current_distance = round(sum(yearly_activites$distance), digits = 1)

gauge(current_distance, min = 0, max = strava_goals$yearly_km, symbol = 'km', gaugeSectors(
  success = c(80, 100), warning = c(40, 79), danger = c(0, 39)
))
```


Activities {data-icon="fa-signal"}
=======================================================================

Row
-----------------------------------------------------------------------
### Type of workouts
```{r}
p <- ggplot(df, aes(type)) +
  geom_bar()
ggplotly(p)
```

### Length of workouts
```{r}
p <- ggplot(df, aes(x=distance, color=type)) +
  geom_histogram(fill="white", alpha=0.5, position="identity")
ggplotly(p)
```

Row
-----------------------------------------------------------------------
### Distance of workouts per type
```{r}
hchart(df$type, name="Number of workouts")
```

### Some other plot
```{r}
hchart(df$distance, name="Number of workouts")
```


All activities {data-icon="fa-strava"}
=======================================================================
Row
-----------------------------------------------------------------------
### Activities in table format
```{r}
```